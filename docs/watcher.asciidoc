
= Crunchy Watch Container
Crunchy Data Solutions, Inc.
v1.2, {docdate}
:title-logo-image: image:crunchy_logo.png["CrunchyData Logo",align="center",scaledwidth="80%"]

== Description

We create a container, crunchy-watch, that lives inside a pod
with a master container.

The watch container has access to a service account that is used
inside the container to issue commands to openshift.

You set up the SA using this:

oc create -f sa.json

You then set up permissions for the SA to edit stuff in the openshift project,
this example allows all service accounts to edit resources in the 'openshift'
project:

~~~~~~~~~~~
oc policy add-role-to-group edit system:serviceaccounts -n openshift
~~~~~~~~~~~

You then reference the SA within the POD spec:

watch-logic.sh is an example of what can run inside the watch container

I copy the oc command into the container from the host when the container
image is built.  I could not find a way to install this using the redhat 
rpms, so I manually add it to the container.

=== Environment Variables

 * SLEEP_TIME - the time to sleep in seconds between checking on the master
 * PG_MASTER_SERVICE -  the master service name
 * PG_SLAVE_SERVICE - the slave service name
 * PG_MASTER_PORT - database port to use when checking the database
 * PG_MASTER_USER -  database user account to use when checking the database
   using pg_isready utility
 * PG_DATABASE - database to use when checking the database using pg_isready

=== Logic

The watch container will watch the master, if the master dies, then 
the watcher will:

 * create the trigger file on the slave that will become the new master
 * change the labels on the slave to be those of the master
 * will start watching the new master in case that falls over next


=== Example

Examples of using the container are found in the standalone and openshift
documents.

== Legal Notices

Copyright Â© 2016 Crunchy Data Solutions, Inc.

CRUNCHY DATA SOLUTIONS, INC. PROVIDES THIS GUIDE "AS IS" WITHOUT WARRANTY OF ANY KIND, EITHER EXPRESS OR IMPLIED, INCLUDING, BUT NOT LIMITED TO, THE IMPLIED WARRANTIES OF NON INFRINGEMENT, MERCHANTABILITY OR FITNESS FOR A PARTICULAR PURPOSE.

Crunchy, Crunchy Data Solutions, Inc. and the Crunchy Hippo Logo are trademarks of Crunchy Data Solutions, Inc.

